---
title: "Situation Report"
author: "HZI Analysis, Output and Research"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::word_document2:
    reference_docx: text/template.docx
    number_sections: true
    fig_width: 7
    fig_height: 6
    fig_caption: yes
bibliography: text/references.bib
link-citations: yes
---
```{r setup, include = FALSE}
# setting knitr chunk options
knitr::opts_chunk$set(echo = FALSE, tab.cap.style = "Table Caption")
```

```{r load_packages, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# loading packages
library(plyr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(flextable)
library(ggplot2)
library(ggspatial)
library(gridExtra)
library(sormasdatagen)
library(cowplot)
library(stringr)
library(sp)
library(sf)
library(geojsonio)
library(broom)
library(fuzzyjoin)
library(rio)
library(Rcpp)
library(writexl)
library(readxl)
library(viridis)
library(readtext)
library(XML)
library(rlang)
library(mgsub)
```

```{r source_code, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
# loading source code from R folder
file.sources <- list.files("R",full.names=TRUE) 
sapply(file.sources,source)
```

```{r flextable settings, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# setting flextable options
set_flextable_defaults(big.mark = " ",
  font.size = 9, theme_fun = theme_vanilla,
  padding.bottom = 6,
  padding.top = 6,
  padding.left = 5,
  padding.right = 5,
  background.color = "#EFEFEF")

```

```{r text_import}
# reading in text for situation report to dataframe
txt_files<- readtext::readtext("text/*.docx")
text <- data.frame(txt_files[,-1], row.names=txt_files[,1])
```

```{r matching_key, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# importing matching key
matching_key <- readxl::read_xlsx("data/matching_key.xlsx")
```

```{r prep_pop_data, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE }
###################
# POPULATION DATA #
###################

# loading raw population data file 
load("data/population_data.rda")

# geting prepared pop data for most recent year and impute data for diverse gender
pop_data <- PREP_POPULATION_DATA(population_data,
                                 divers_imputation = TRUE)
```

```{r prep_sormas_data, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
###############
# SORMAS DATA #
###############

#load raw sormas test data file
load("data/sormas_testdata.rda")

# persons is the dataframe of interest for the sitrep 
# use matching_key for joining health_authorities to counties and states
d <- PREP_SORMAS_DATA(sormas_persons = sormas_testdata$persons,
                      matching_key = matching_key)
```

```{r master_table, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
################
# MASTER TABLE #
################

## getting master table, which is used for the overview table, state table and county map
master_table <- GET_MASTER_TABLE(population_data = pop_data,
                        persons_sormasdata = d,
                        key = matching_key)
```

```{r prep_geodata, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
############
# GEO DATA #
############

## importing geo data
geo_shapes <- sormasdatagen::GetGeoData()$geoshapes

# prepping geo data
geo_shapes_data <- PREP_GEO_DATA(geo_shapes = geo_shapes,
                                 master_table = master_table)
```

```{r prep_timeseries, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
####################
# TIME SERIES DATA #
####################

## getting timeseries data
ts_data <- GET_TIMESERIES_DATA(d)
```

```{r prep_agegroup_gender, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
##################
# DEATH INC DATA #
##################

## getting agegroup & gender data for death incidences
agegroup_gender_data <- GET_AGEGROUP_GENDER_DATA(d, pop_data)
```

```{r building_tables}
##########
# TABLES #
##########

## getting overview table
overview_table <- GET_OVERVIEW_TABLE(master_table = master_table)

## getting state table
state_table <- GET_STATE_TABLE(master_table = master_table)
```

```{r values_to_text}

# keys for table values
pattern_vec <- c("#Otc",
                 "#Onc",
                 "#Oth",
                 "#Onh",
                 "#Otd",
                 "#Ond",
                 "#Oi7",
                 "#Oc7"
                 )

replacement_vec <- c(overview_table$`Total cases`,
                     overview_table$`New cases`,
                     overview_table$`Total hospitalizations`,
                     overview_table$`New hospitalizations`,
                     overview_table$`Total deaths`,
                     overview_table$`New deaths`,
                     overview_table$`7 day Incidence`,
                     overview_table$`Change since yesterday`,
                     overview_table$`7 Day Incidence`,
                     overview_table$`Change in 7 day incidence since yesterday`
                     )

# pattern and replacement vectors to be imported from separate file

# importing values from data into text
text$txt_files....1. <- mgsub(text$txt_files....1., pattern = pattern_vec,
                              replacement = replacement_vec 
                              ) 
```

# Introduction
`r text["INTRO.docx",1]` Figure \@ref(tab:OverviewTable)

## Overview
`r text["OVERVIEW.docx",1]`

```{r OverviewTable, error=FALSE, message=FALSE, warning=FALSE, tab.cap= "Overview Table"}
#displaying overview table
flextable::flextable(overview_table)
```

# Epidemic Dynamic
`r text["EPID_DYN.docx",1]` 

## Time series data
`r text["TIME_SER.docx",1]`

```{r TimeSeriesData, warning=FALSE, message=FALSE, error=FALSE, fig.cap="Time series data"}
# plotting timeseries data
PLOT_TIMESERIES(timeseries_data = ts_data)
```

\newpage

## Death incidences by age groups
`r text["DEATH_INC.docx",1]`

```{r DeathIncidencesDistribution, warning=FALSE, message=FALSE, error=FALSE, fig.cap ="Death Incidences Distribution"}

# plotting death incidences for genders and age groups 
# possible variables of interest:
# tot_death_inc = total death incidence
# tot_hosp_inc = total hospitalization incidence
# tot_case_inc = total case incidence

PLOT_AGEGROUP_GENDER(agegroup_gender_data = agegroup_gender_data, voi = "tot_death_inc")
```


# Regional Situation
`r text["REG_SIT.docx",1]`

\newpage

## State level table
`r text["STATE_TBL.docx",1]`

```{r StateLevelTable, warning = FALSE, tab.cap= "State level table", tab.cap="State Level Table"}
# displaying state table
flextable::flextable(state_table)
```

\newpage
## County level map
`r text["COUNTY_MAP.docx",1]`

```{r CountyLevelMap, echo = FALSE, warning=FALSE, message=FALSE, fig.cap= "County level map"}
# displaying county map
PLOT_COUNTY_MAP(geo_shapes_data = geo_shapes_data)
```

\newpage

# Remarks
`r text["REMARKS.docx",1]`

As illustrated in Figure \@ref(fig:TimeSeriesData) there was a spike in
all three time series in the third quarter of 2020.

Table \@ref(tab:StateLevelTable) and Table \@ref(tab:OverviewTable) show summary statistics.

[@lang1997income]

[@dplyrref]

\newpage

# References
